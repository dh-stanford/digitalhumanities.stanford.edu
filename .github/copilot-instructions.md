# Digital Humanities @ Stanford - AI Agent Instructions

## Architecture Overview

This is an **Eleventy 2.0** static site using Liquid/Nunjucks templates. The site is based on the Mundana Jekyll theme, ported to Eleventy with modern vanilla JavaScript (no jQuery/Bootstrap JS).

- **Build tool**: Eleventy (`npm run build` or `yarn build`)
- **Dev server**: `npm run dev` (serves at `http://localhost:8080` with live reload)
- **Deployment**: `yarn gh-deploy` (builds and pushes to `gh-pages` branch; must be on `main` with clean working directory)

## Content & File Structure

- **Articles**: Markdown files in `src/*.md` with YAML frontmatter (layout, title, author, date, post_images)
- **Projects**: Markdown files in `projects/*.md`, consumed by `src/_data/projects.js` and rendered via `src/_includes/templates/projects.njk`
- **Images**: Place in `post-images/` folder; reference in frontmatter `post_images` array
- **Templates**: 
  - Base layout: `src/_includes/mundana/base-layout.njk`
  - Article/page layouts: `src/_includes/templates/article.liquid` and `page.liquid`
  - Partials: `src/_includes/mundana/` (navigation, search, front-page loop)

## Configuration & Custom Logic

- **Eleventy config**: `.eleventy.js` defines:
  - Passthrough copies for assets and images
  - Custom filters: `cssmin`, `formatDate` (converts UTC dates to locale), `markdown`, `excerpt`
  - Custom collection: `pages` (sorted by date DESC from `src/*.md`)
  - Template engines: Nunjucks for `.njk`, Liquid for `.liquid`, markdown with `njk` engine
- **Utilities**: `lib/utils.js` exports `renderMarkdown` and `extractExcerpt` (200-char cap with ellipsis)
- **Search**: Lunr.js index generated by `src/lunr.json.11ty.js`; client-side search in `src/_includes/mundana/search-lunr.liquid`

## Key Conventions & Patterns

1. **Date handling**: Eleventy/YAML parse dates as UTC; `formatDate` filter compensates by forcing UTC zone interpretation
2. **Frontmatter**: Always include `layout`, `title`, `author`, `date`, and at least one `post_images` entry for collection pages
3. **Accessibility**: Site follows WCAG 2 guidelines:
   - Skip link to `#main-content`
   - Semantic landmarks (`role="navigation"`, `role="main"`)
   - ARIA labels on search form, modals, external links, pagination
   - Focus management in search modal (focus trap, return focus on close)
   - Visible focus outlines (3px solid)
4. **Liquid conditionals**: Use block-style `{% if %}...{% endif %}` for conditional attributes; inline conditionals inside attributes cause parse errors
5. **Navigation**: Current page marked with `aria-current="page"` on homepage only (checking `page.url`)

## Common Tasks

- **Add article**: Create `src/new-article.md` with proper frontmatter, add image to `post-images/`, run dev server to preview
- **Add project**: Create `projects/project-name.md` with `title`, `image` frontmatter; image path relative to project file (e.g., `images/project.jpg`)
- **Edit templates**: Modify files in `src/_includes/`; Eleventy auto-reloads on save during `npm run dev`
- **Update styles**: Edit `assets/css/theme.css` (custom theme styles) or `assets/css/main.css` (Bootstrap base); minified CSS via `cssmin` filter
- **Deploy**: Ensure on `main` branch, commit all changes, run `yarn gh-deploy` (script checks branch and clean status before deploying)

## Accessibility Testing

Run automated accessibility tests with:
- `npm run a11y` - Tests key pages (home, about, projects) with @axe-core/cli for WCAG 2 A, AA, and WCAG 2.1 AA compliance
- `npm run a11y:full` - Tests first 20 pages in the site

Address any violations before deployment. Note that automated testing catches only 20-50% of accessibility issues; manual testing with screen readers and keyboard navigation is always required.

## Avoid These Pitfalls

- Don't use inline Liquid conditionals inside HTML attributes (use block-style instead)
- Don't forget the first `post_images` entryâ€”it's used as the featured image on list pages
- Don't deploy from branches other than `main` or with uncommitted changes (`gh-deploy.sh` will abort)
- Don't modify `_site/` manually (it's generated on each build and gitignored)
